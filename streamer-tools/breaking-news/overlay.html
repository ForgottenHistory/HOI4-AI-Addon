<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Breaking News Ticker</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: transparent;
            overflow: hidden;
            margin: 0;
            padding: 0;
        }

        .news-ticker-container {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 60px;
            background: linear-gradient(135deg, #cc0000, #ff3333);
            display: flex;
            align-items: center;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.5);
            z-index: 9999;
            overflow: hidden;
        }

        /* Priority-based styling */
        .news-ticker-container.priority-high {
            background: linear-gradient(135deg, #cc0000, #ff0000);
            animation: urgentPulse 2s infinite;
        }

        .news-ticker-container.priority-medium {
            background: linear-gradient(135deg, #cc6600, #ff8800);
        }

        .news-ticker-container.priority-low {
            background: linear-gradient(135deg, #666666, #888888);
        }

        @keyframes urgentPulse {
            0%, 100% { 
                opacity: 1; 
                box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.5);
            }
            50% { 
                opacity: 0.85; 
                box-shadow: 0 -2px 15px rgba(255, 0, 0, 0.7);
            }
        }

        .breaking-news-label {
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 0 20px;
            height: 100%;
            display: flex;
            align-items: center;
            font-weight: bold;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 1px;
            white-space: nowrap;
            border-right: 3px solid rgba(255, 255, 255, 0.3);
            flex-shrink: 0;
            min-width: 160px;
            justify-content: center;
        }

        .news-ticker {
            flex: 1;
            height: 100%;
            overflow: hidden;
            position: relative;
            background: rgba(0, 0, 0, 0.1);
        }

        .ticker-content {
            position: absolute;
            display: flex;
            white-space: nowrap;
            line-height: 60px;
            font-size: 18px;
            font-weight: 600;
            height: 60px;
            top: 0;
            will-change: transform;
        }

        .ticker-item {
            padding: 0 100px;
            display: inline-block;
            color: white;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
            white-space: nowrap;
        }

        /* Fade edges for smoother visual */
        .news-ticker::before,
        .news-ticker::after {
            content: '';
            position: absolute;
            top: 0;
            bottom: 0;
            width: 50px;
            z-index: 2;
            pointer-events: none;
        }

        .news-ticker::before {
            left: 0;
            background: linear-gradient(to right, rgba(0, 0, 0, 0.3), transparent);
        }

        .news-ticker::after {
            right: 0;
            background: linear-gradient(to left, rgba(0, 0, 0, 0.3), transparent);
        }

        /* Responsive adjustments */
        @media (max-width: 1200px) {
            .news-ticker-container {
                height: 55px;
            }
            
            .ticker-content {
                font-size: 16px;
                line-height: 55px;
                height: 55px;
            }
            
            .breaking-news-label {
                font-size: 13px;
                min-width: 140px;
                padding: 0 15px;
            }
        }

        @media (max-width: 768px) {
            .news-ticker-container {
                height: 50px;
            }
            
            .ticker-content {
                font-size: 14px;
                line-height: 50px;
                height: 50px;
            }
            
            .breaking-news-label {
                font-size: 12px;
                min-width: 120px;
                padding: 0 12px;
            }
        }

        /* Accessibility and reduced motion support */
        @media (prefers-reduced-motion: reduce) {
            .news-ticker-container.priority-high {
                animation: none;
            }
        }

        /* High contrast mode support */
        @media (prefers-contrast: high) {
            .news-ticker-container {
                background: #000000;
                border-top: 2px solid #ffffff;
            }
            
            .breaking-news-label {
                background: #ffffff;
                color: #000000;
                border-right: 3px solid #000000;
            }
            
            .ticker-item {
                color: #ffffff;
                text-shadow: none;
                font-weight: bold;
            }
        }
    </style>
</head>
<body>
    <div class="news-ticker-container" id="tickerContainer">
        <div class="breaking-news-label">
            ðŸš¨ BREAKING NEWS
        </div>
        <div class="news-ticker">
            <div class="ticker-content" id="ticker">
                <!-- Content will be dynamically generated -->
            </div>
        </div>
    </div>

    <script>
        class NewsTickerController {
            constructor() {
                this.tickerElement = document.getElementById('ticker');
                this.containerElement = document.getElementById('tickerContainer');
                this.headlines = []; // Array to store multiple headlines
                this.lastHeadlineId = null;
                this.position = 0;
                this.speed = 1; // pixels per frame
                this.isPaused = false;
                this.animationId = null;
                this.singleItemWidth = 0;
                this.updateInterval = 10000; // Check for new headlines every 10 seconds
                this.maxHeadlines = 5; // Maximum number of headlines to keep
                this.hasQueuedUpdate = false; // Flag for queued content updates
                
                this.init();
            }

            init() {
                this.fetchHeadline();
                setInterval(() => this.fetchHeadline(), this.updateInterval);
                this.animate();
            }

            async fetchHeadline() {
                try {
                    const response = await fetch('/current-headline');
                    if (response.ok) {
                        const headline = await response.json();
                        
                        // Only update if we have a new headline
                        if (headline && headline.id !== this.lastHeadlineId) {
                            this.addHeadline(headline);
                            this.lastHeadlineId = headline.id;
                        }
                    }
                } catch (error) {
                    console.warn('Failed to fetch headline:', error);
                    if (this.headlines.length === 0) {
                        this.showFallbackHeadlines();
                    }
                }
            }

            addHeadline(headline) {
                // Add new headline to the array
                this.headlines.push(headline);
                
                // Keep only the most recent headlines
                if (this.headlines.length > this.maxHeadlines) {
                    this.headlines = this.headlines.slice(-this.maxHeadlines);
                }
                
                // Check if we can update now, or need to queue for later
                if (this.canUpdateContent()) {
                    this.updateTickerContent();
                    console.log(`Immediately updated with headline: ${headline.headline}`);
                } else {
                    this.hasQueuedUpdate = true;
                    console.log(`Queued headline for update: ${headline.headline}`);
                }
                
                // Always update priority styling (doesn't affect position)
                this.updatePriorityStyle(headline.priority);
                
                console.log(`Total headlines: ${this.headlines.length}`);
            }

            canUpdateContent() {
                if (this.singleItemWidth === 0) return true; // First time, always allow
                
                // Calculate how far we are through the current cycle (0 = start, 1 = end)
                const cycleProgress = (Math.abs(this.position) % this.singleItemWidth) / this.singleItemWidth;
                
                // Only allow updates in the first 20% of the cycle (when text is mostly off-screen on the right)
                return cycleProgress < 0.2;
            }

            updateTickerContent() {
                if (this.headlines.length === 0) return;
                
                // Calculate current scroll percentage to maintain relative position
                const scrollPercent = this.singleItemWidth > 0 ? (Math.abs(this.position) % this.singleItemWidth) / this.singleItemWidth : 0;
                
                // Create news string from all headlines
                const newsString = this.headlines.map(h => h.headline).join(' â€¢ ');
                
                // Update existing items if they exist, otherwise create new ones
                const items = this.tickerElement.querySelectorAll('.ticker-item');
                
                if (items.length === 3) {
                    // Update existing items without recreating DOM
                    items.forEach(item => {
                        item.textContent = newsString;
                    });
                } else {
                    // Create from scratch only if needed
                    this.tickerElement.innerHTML = '';
                    
                    for (let i = 0; i < 3; i++) {
                        const span = document.createElement('span');
                        span.className = 'ticker-item';
                        span.textContent = newsString;
                        this.tickerElement.appendChild(span);
                    }
                }
                
                // Calculate new width and maintain scroll position
                setTimeout(() => {
                    const firstItem = this.tickerElement.querySelector('.ticker-item');
                    if (firstItem) {
                        const newWidth = firstItem.offsetWidth;
                        
                        // Only adjust position if width actually changed
                        if (newWidth !== this.singleItemWidth && newWidth > 0) {
                            // Maintain the same scroll percentage with new width
                            this.position = -(scrollPercent * newWidth);
                            this.singleItemWidth = newWidth;
                            console.log(`Width changed: ${this.singleItemWidth}px, position adjusted to maintain flow`);
                        }
                    }
                }, 10);
            }

            animate() {
                if (!this.isPaused && this.singleItemWidth > 0) {
                    this.position -= this.speed;
                    
                    // Reset position when first item is completely off screen
                    if (Math.abs(this.position) >= this.singleItemWidth) {
                        this.position += this.singleItemWidth;
                        console.log(`Position reset at width: ${this.singleItemWidth}`);
                    }
                    
                    // Check if we can process queued updates (when in the safe zone)
                    if (this.hasQueuedUpdate && this.canUpdateContent()) {
                        this.updateTickerContent();
                        this.hasQueuedUpdate = false;
                        console.log('Processed queued headline update');
                    }
                    
                    this.tickerElement.style.transform = `translateX(${this.position}px)`;
                }
                
                this.animationId = requestAnimationFrame(() => this.animate());
            }

            updatePriorityStyle(priority) {
                // Remove existing priority classes
                this.containerElement.classList.remove('priority-high', 'priority-medium', 'priority-low');
                
                // Add new priority class
                if (priority) {
                    this.containerElement.classList.add(`priority-${priority}`);
                }
            }

            showFallbackHeadlines() {
                const fallbackHeadlines = [
                    "Local Nation Experiences Events",
                    "Breaking: Something Happening Somewhere", 
                    "World Continues to Exist Despite Everything",
                    "International Community Still Figuring Things Out",
                    "Global Situation Remains Globally Situated"
                ];
                
                // Add all fallback headlines
                fallbackHeadlines.forEach((headline, index) => {
                    this.headlines.push({
                        id: Date.now() + index,
                        headline: headline,
                        priority: 'low'
                    });
                });
                
                this.updateTickerContent();
                this.updatePriorityStyle('low');
            }

            // Cleanup method
            destroy() {
                if (this.animationId) {
                    cancelAnimationFrame(this.animationId);
                }
            }
        }

        // Initialize the ticker when the page loads
        let tickerController;
        document.addEventListener('DOMContentLoaded', () => {
            tickerController = new NewsTickerController();
        });

        // Handle visibility change to pause/resume animations when tab is not visible
        document.addEventListener('visibilitychange', () => {
            if (tickerController) {
                tickerController.isPaused = document.hidden;
            }
        });

        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            if (tickerController) {
                tickerController.destroy();
            }
        });
    </script>
</body>
</html>